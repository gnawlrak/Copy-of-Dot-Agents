<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>房间更新监听测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .log {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .room-info {
            background-color: #e9f7ef;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>房间更新监听测试</h1>
        <p>此页面用于测试房间更新监听功能是否正常工作。打开多个此页面标签，在一个标签中创建房间，在另一个标签中加入房间，检查控制台日志。</p>
        
        <div class="test-section">
            <h2>测试步骤</h2>
            <ol>
                <li>在第一个标签中点击"创建房间"按钮</li>
                <li>在第二个标签中点击"刷新房间列表"按钮</li>
                <li>在第二个标签中点击"加入房间"按钮</li>
                <li>检查第一个标签的控制台是否显示"有玩家加入了房间"的日志</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h2>房间操作</h2>
            <button id="createRoom">创建房间</button>
            <button id="refreshRooms">刷新房间列表</button>
            <button id="joinRoom">加入房间</button>
            <button id="leaveRoom">离开房间</button>
            <div id="roomInfo" class="room-info" style="display: none;">
                <h3>当前房间信息</h3>
                <div id="roomDetails"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>日志</h2>
            <button id="clearLog">清空日志</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script type="module">
        // 模拟网络客户端和房间管理
        let currentRoom = null;
        let playerId = 'player_' + Math.random().toString(36).substr(2, 9);
        let isOwner = false;
        
        // 日志函数
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        // 清空日志
        document.getElementById('clearLog').addEventListener('click', () => {
            document.getElementById('log').textContent = '';
        });
        
        // 创建房间
        document.getElementById('createRoom').addEventListener('click', () => {
            const roomId = 'room_' + Math.random().toString(36).substr(2, 9);
            const room = {
                id: roomId,
                name: `测试房间 ${roomId.substr(-6)}`,
                ownerId: playerId,
                players: {
                    [playerId]: {
                        id: playerId,
                        x: 0,
                        y: 0,
                        direction: 0,
                        health: 100,
                        team: 'red',
                        role: 'assault',
                        score: 0,
                        kills: 0,
                        deaths: 0,
                        ping: 0,
                        isReady: false
                    }
                },
                createdAt: Date.now(),
                status: 'waiting',
                type: 'public',
                settings: {
                    gameMode: 'deathmatch',
                    map: 'default',
                    timeLimit: 600,
                    scoreLimit: 100,
                    friendlyFire: false,
                    maxPlayers: 8,
                    teamSize: 4,
                    autoBalance: true,
                    difficulty: 'normal',
                    customRules: []
                },
                currentPlayers: 1,
                region: 'default',
                ping: 0,
                tags: ['deathmatch'],
                statistics: {
                    gamesPlayed: 0,
                    averageDuration: 0,
                    playerSatisfaction: 0,
                    successRate: 0
                }
            };
            
            // 保存房间到localStorage
            try {
                const rooms = JSON.parse(localStorage.getItem('dot_agents_rooms') || '[]');
                rooms.push(room);
                localStorage.setItem('dot_agents_rooms', JSON.stringify(rooms));
                
                // 使用BroadcastChannel通知其他标签页
                if (typeof BroadcastChannel !== 'undefined') {
                    const channel = new BroadcastChannel('dot_agents_rooms');
                    channel.postMessage({
                        type: 'rooms_updated',
                        rooms: rooms,
                        timestamp: Date.now()
                    });
                    channel.close();
                }
                
                currentRoom = room;
                isOwner = true;
                updateRoomInfo(room);
                log(`创建房间成功: ${room.name} (${room.id})`);
            } catch (e) {
                log(`创建房间失败: ${e.message}`);
            }
        });
        
        // 刷新房间列表
        document.getElementById('refreshRooms').addEventListener('click', () => {
            try {
                const rooms = JSON.parse(localStorage.getItem('dot_agents_rooms') || '[]');
                log(`找到 ${rooms.length} 个房间`);
                rooms.forEach(room => {
                    log(`- ${room.name} (${room.id}) - 玩家数: ${room.currentPlayers}/${room.settings.maxPlayers}`);
                });
            } catch (e) {
                log(`刷新房间列表失败: ${e.message}`);
            }
        });
        
        // 加入房间
        document.getElementById('joinRoom').addEventListener('click', () => {
            try {
                const rooms = JSON.parse(localStorage.getItem('dot_agents_rooms') || '[]');
                if (rooms.length === 0) {
                    log('没有可加入的房间');
                    return;
                }
                
                // 加入第一个房间
                const room = rooms[0];
                
                // 添加玩家到房间
                room.players[playerId] = {
                    id: playerId,
                    x: 0,
                    y: 0,
                    direction: 0,
                    health: 100,
                    team: room.currentPlayers % 2 === 0 ? 'red' : 'blue',
                    role: 'support',
                    score: 0,
                    kills: 0,
                    deaths: 0,
                    ping: 0,
                    isReady: false
                };
                room.currentPlayers++;
                
                // 更新localStorage
                localStorage.setItem('dot_agents_rooms', JSON.stringify(rooms));
                
                // 使用BroadcastChannel通知其他标签页
                if (typeof BroadcastChannel !== 'undefined') {
                    const channel = new BroadcastChannel('dot_agents_rooms');
                    channel.postMessage({
                        type: 'rooms_updated',
                        rooms: rooms,
                        timestamp: Date.now()
                    });
                    channel.close();
                }
                
                currentRoom = room;
                isOwner = false;
                updateRoomInfo(room);
                log(`加入房间成功: ${room.name} (${room.id})`);
            } catch (e) {
                log(`加入房间失败: ${e.message}`);
            }
        });
        
        // 离开房间
        document.getElementById('leaveRoom').addEventListener('click', () => {
            if (!currentRoom) {
                log('当前不在任何房间中');
                return;
            }
            
            try {
                const rooms = JSON.parse(localStorage.getItem('dot_agents_rooms') || '[]');
                const roomIndex = rooms.findIndex(r => r.id === currentRoom.id);
                
                if (roomIndex !== -1) {
                    const room = rooms[roomIndex];
                    
                    // 从房间中移除玩家
                    if (room.players[playerId]) {
                        delete room.players[playerId];
                        room.currentPlayers--;
                    }
                    
                    // 如果房间没有玩家了，删除房间
                    if (room.currentPlayers === 0) {
                        rooms.splice(roomIndex, 1);
                        log(`房间 ${room.name} 已删除`);
                    } else {
                        // 如果房主离开，指定新的房主
                        if (room.ownerId === playerId) {
                            const remainingPlayerIds = Object.keys(room.players);
                            if (remainingPlayerIds.length > 0) {
                                room.ownerId = remainingPlayerIds[0];
                                log(`新房主: ${room.ownerId}`);
                            }
                        }
                    }
                    
                    // 更新localStorage
                    localStorage.setItem('dot_agents_rooms', JSON.stringify(rooms));
                    
                    // 使用BroadcastChannel通知其他标签页
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('dot_agents_rooms');
                        channel.postMessage({
                            type: 'rooms_updated',
                            rooms: rooms,
                            timestamp: Date.now()
                        });
                        channel.close();
                    }
                }
                
                currentRoom = null;
                isOwner = false;
                updateRoomInfo(null);
                log(`离开房间成功`);
            } catch (e) {
                log(`离开房间失败: ${e.message}`);
            }
        });
        
        // 更新房间信息显示
        function updateRoomInfo(room) {
            const roomInfo = document.getElementById('roomInfo');
            const roomDetails = document.getElementById('roomDetails');
            
            if (!room) {
                roomInfo.style.display = 'none';
                return;
            }
            
            roomInfo.style.display = 'block';
            const playerList = Object.values(room.players).map(p => 
                `${p.id.substr(0, 8)} (${p.team === 'red' ? '红队' : '蓝队'})`
            ).join(', ');
            
            roomDetails.innerHTML = `
                <p><strong>房间ID:</strong> ${room.id}</p>
                <p><strong>房间名称:</strong> ${room.name}</p>
                <p><strong>房主:</strong> ${room.ownerId === playerId ? '你' : room.ownerId.substr(0, 8)}</p>
                <p><strong>玩家数:</strong> ${room.currentPlayers}/${room.settings.maxPlayers}</p>
                <p><strong>游戏模式:</strong> ${room.settings.gameMode}</p>
                <p><strong>玩家列表:</strong> ${playerList}</p>
            `;
        }
        
        // 监听房间更新
        function setupRoomUpdateListener() {
            // 监听storage事件
            window.addEventListener('storage', (event) => {
                if (event.key === 'dot_agents_rooms' && event.newValue) {
                    try {
                        const oldRooms = JSON.parse(event.oldValue || '[]');
                        const newRooms = JSON.parse(event.newValue);
                        
                        // 检查房间更新
                        checkRoomUpdates(oldRooms, newRooms);
                        
                        // 如果当前在房间中，更新房间信息
                        if (currentRoom) {
                            const updatedRoom = newRooms.find(r => r.id === currentRoom.id);
                            if (updatedRoom) {
                                currentRoom = updatedRoom;
                                updateRoomInfo(updatedRoom);
                            } else {
                                // 房间被删除了
                                currentRoom = null;
                                isOwner = false;
                                updateRoomInfo(null);
                                log('房间已被删除');
                            }
                        }
                    } catch (e) {
                        log(`处理storage事件失败: ${e.message}`);
                    }
                }
            });
            
            // 监听BroadcastChannel
            if (typeof BroadcastChannel !== 'undefined') {
                try {
                    const channel = new BroadcastChannel('dot_agents_rooms');
                    channel.onmessage = (event) => {
                        if (event.data && event.data.type === 'rooms_updated') {
                            try {
                                const oldRooms = JSON.parse(localStorage.getItem('dot_agents_rooms') || '[]');
                                const newRooms = event.data.rooms || [];
                                
                                // 检查房间更新
                                checkRoomUpdates(oldRooms, newRooms);
                                
                                // 更新localStorage
                                localStorage.setItem('dot_agents_rooms', JSON.stringify(newRooms));
                                
                                // 如果当前在房间中，更新房间信息
                                if (currentRoom) {
                                    const updatedRoom = newRooms.find(r => r.id === currentRoom.id);
                                    if (updatedRoom) {
                                        currentRoom = updatedRoom;
                                        updateRoomInfo(updatedRoom);
                                    } else {
                                        // 房间被删除了
                                        currentRoom = null;
                                        isOwner = false;
                                        updateRoomInfo(null);
                                        log('房间已被删除');
                                    }
                                }
                            } catch (e) {
                                log(`处理BroadcastChannel消息失败: ${e.message}`);
                            }
                        }
                    };
                } catch (e) {
                    log(`设置BroadcastChannel监听失败: ${e.message}`);
                }
            }
        }
        
        // 检查房间更新
        function checkRoomUpdates(oldRooms, newRooms) {
            // 创建旧房间ID到房间的映射
            const oldRoomMap = new Map(oldRooms.map(room => [room.id, room]));
            
            // 检查每个新房间是否有更新
            newRooms.forEach(newRoom => {
                const oldRoom = oldRoomMap.get(newRoom.id);
                
                // 如果是新房间
                if (!oldRoom) {
                    log(`新房间创建: ${newRoom.name} (${newRoom.id})`);
                    return;
                }
                
                // 检查玩家变化
                const oldPlayerIds = Object.keys(oldRoom.players);
                const newPlayerIds = Object.keys(newRoom.players);
                
                // 找出新增的玩家ID
                const newPlayers = newPlayerIds.filter(id => !oldPlayerIds.includes(id));
                
                // 如果有新玩家加入，在房主端控制台输出日志
                if (newPlayers.length > 0 && isOwner && currentRoom && currentRoom.id === newRoom.id) {
                    log(`[房主通知] 有${newPlayers.length}名玩家加入了房间:`, newPlayers);
                    newPlayers.forEach(playerId => {
                        const player = newRoom.players[playerId];
                        if (player) {
                            log(`[房主通知] 玩家 ${playerId.slice(0, 8)} (${player.team === 'red' ? '红队' : '蓝队'}) 加入了房间`);
                        }
                    });
                }
                
                // 找出离开的玩家ID
                const leftPlayers = oldPlayerIds.filter(id => !newPlayerIds.includes(id));
                
                // 如果有玩家离开，在房主端控制台输出日志
                if (leftPlayers.length > 0 && isOwner && currentRoom && currentRoom.id === newRoom.id) {
                    log(`[房主通知] 有${leftPlayers.length}名玩家离开了房间:`, leftPlayers);
                    leftPlayers.forEach(playerId => {
                        log(`[房主通知] 玩家 ${playerId.slice(0, 8)} 离开了房间`);
                    });
                }
                
                // 如果房间有其他变化
                if (JSON.stringify(oldRoom) !== JSON.stringify(newRoom)) {
                    log(`房间更新: ${newRoom.name} (${newRoom.id})`);
                }
            });
            
            // 检查被删除的房间
            const deletedRooms = oldRooms.filter(oldRoom => 
                !newRooms.find(newRoom => newRoom.id === oldRoom.id)
            );
            
            deletedRooms.forEach(room => {
                log(`房间删除: ${room.name} (${room.id})`);
            });
        }
        
        // 初始化
        log(`测试页面初始化完成，玩家ID: ${playerId}`);
        setupRoomUpdateListener();
        
        // 检查当前是否已在房间中
        try {
            const rooms = JSON.parse(localStorage.getItem('dot_agents_rooms') || '[]');
            const roomWithPlayer = rooms.find(room => room.players[playerId]);
            if (roomWithPlayer) {
                currentRoom = roomWithPlayer;
                isOwner = roomWithPlayer.ownerId === playerId;
                updateRoomInfo(roomWithPlayer);
                log(`检测到已在房间中: ${roomWithPlayer.name} (${roomWithPlayer.id})`);
            }
        } catch (e) {
            log(`检查当前房间状态失败: ${e.message}`);
        }
    </script>
</body>
</html>