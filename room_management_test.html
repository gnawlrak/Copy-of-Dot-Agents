<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>房间管理功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .section {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .button:hover {
            background-color: #45a049;
        }
        .button.danger {
            background-color: #f44336;
        }
        .button.danger:hover {
            background-color: #d32f2f;
        }
        .button.warning {
            background-color: #ff9800;
        }
        .button.warning:hover {
            background-color: #e68900;
        }
        .log {
            background-color: #000;
            padding: 10px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        .player-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .player {
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player.red {
            background-color: rgba(255, 0, 0, 0.3);
        }
        .player.blue {
            background-color: rgba(0, 0, 255, 0.3);
        }
        .player.ready {
            border-left: 4px solid #4CAF50;
        }
        .player.not-ready {
            border-left: 4px solid #ff9800;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: #333;
        }
        h2 {
            margin-top: 0;
            color: #4CAF50;
        }
        h3 {
            margin-top: 0;
            color: #2196F3;
        }
        .room-info {
            background-color: #333;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .player-actions {
            display: flex;
            gap: 5px;
        }
        .player-actions button {
            padding: 2px 5px;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <h1>房间管理功能测试</h1>
    
    <div class="container">
        <div class="left-panel">
            <div class="section">
                <h2>房间控制</h2>
                <div class="room-info">
                    <div>房间ID: <span id="roomId">-</span></div>
                    <div>房间名称: <span id="roomName">-</span></div>
                    <div>玩家数量: <span id="playerCount">0</span></div>
                    <div>房间状态: <span id="roomStatus">未创建</span></div>
                </div>
                <button class="button" onclick="createRoom()">创建房间</button>
                <button class="button" onclick="joinRoom()">加入房间</button>
                <button class="button danger" onclick="leaveRoom()">离开房间</button>
                <button class="button warning" onclick="toggleReady()">切换准备状态</button>
                <button class="button" onclick="startGame()">开始游戏</button>
            </div>
            
            <div class="section">
                <h2>玩家列表</h2>
                <div class="player-list">
                    <div>
                        <h3>红队</h3>
                        <div id="redTeam"></div>
                    </div>
                    <div>
                        <h3>蓝队</h3>
                        <div id="blueTeam"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="section">
                <h2>测试日志</h2>
                <div id="log" class="log"></div>
            </div>
            
            <div class="section">
                <h2>快速测试</h2>
                <button class="button" onclick="testKickPlayer()">测试踢出玩家</button>
                <button class="button" onclick="testSwitchTeam()">测试切换队伍</button>
                <button class="button" onclick="testReadyCheck()">测试准备检查</button>
                <button class="button" onclick="testStartRound()">测试开始游戏</button>
            </div>
        </div>
    </div>

    <script>
        // 模拟网络客户端
        class MockNetworkClient {
            constructor() {
                this.ownId = `player_${Math.random().toString(36).slice(2,9)}`;
                this.handlers = new Map();
                this.connected = false;
                this.currentRoomId = null;
                this.isOwner = false;
                
                // 模拟房间数据
                this.rooms = [];
                this.currentRoom = null;
                
                log(`初始化网络客户端，玩家ID: ${this.ownId}`);
            }
            
            on(event, callback) {
                if (!this.handlers.has(event)) {
                    this.handlers.set(event, []);
                }
                this.handlers.get(event).push(callback);
            }
            
            emit(event, data) {
                if (this.handlers.has(event)) {
                    this.handlers.get(event).forEach(callback => {
                        try {
                            callback(data);
                        } catch (e) {
                            console.error(`事件处理错误: ${event}`, e);
                        }
                    });
                }
            }
            
            send(event, data) {
                log(`发送消息: ${event}, 数据: ${JSON.stringify(data)}`);
                
                // 模拟处理消息
                setTimeout(() => {
                    this.handleMessage(event, data);
                }, 100);
            }
            
            handleMessage(event, data) {
                switch (event) {
                    case 'create-room':
                        this.handleCreateRoom(data);
                        break;
                    case 'join-room':
                        this.handleJoinRoom(data);
                        break;
                    case 'leave-room':
                        this.handleLeaveRoom(data);
                        break;
                    case 'ready-check':
                        this.handleReadyCheck(data);
                        break;
                    case 'team-management':
                        this.handleTeamManagement(data);
                        break;
                    case 'start-round':
                        this.handleStartRound(data);
                        break;
                    default:
                        log(`未处理的消息类型: ${event}`);
                }
            }
            
            handleCreateRoom(data) {
                const room = {
                    id: `room_${Math.random().toString(36).slice(2,9)}`,
                    name: data.name || '测试房间',
                    ownerId: this.ownId,
                    players: {},
                    currentPlayers: 0,
                    status: 'waiting',
                    settings: data.settings || { gameMode: 'team-deathmatch', maxPlayers: 10 }
                };
                
                // 添加房主
                room.players[this.ownId] = {
                    id: this.ownId,
                    team: 'red',
                    isReady: false,
                    role: 'assault'
                };
                room.currentPlayers = 1;
                
                this.rooms.push(room);
                this.currentRoom = room;
                this.currentRoomId = room.id;
                this.isOwner = true;
                
                log(`创建房间成功: ${room.id}`);
                this.emit('room-joined', { roomId: room.id, player: room.players[this.ownId] });
                this.emit('room-updated', room);
            }
            
            handleJoinRoom(data) {
                const room = this.rooms.find(r => r.id === data.roomId);
                if (!room) {
                    log(`加入房间失败: 房间不存在 ${data.roomId}`);
                    return;
                }
                
                // 计算队伍
                const redTeamCount = Object.values(room.players).filter(p => p.team === 'red').length;
                const blueTeamCount = Object.values(room.players).filter(p => p.team === 'blue').length;
                
                let team;
                if (redTeamCount === blueTeamCount) {
                    team = Math.random() < 0.5 ? 'red' : 'blue';
                } else {
                    team = redTeamCount < blueTeamCount ? 'red' : 'blue';
                }
                
                // 添加玩家
                room.players[this.ownId] = {
                    id: this.ownId,
                    team: team,
                    isReady: false,
                    role: 'assault'
                };
                room.currentPlayers = Object.keys(room.players).length;
                
                this.currentRoom = room;
                this.currentRoomId = room.id;
                this.isOwner = false;
                
                log(`加入房间成功: ${room.id}, 队伍: ${team}`);
                this.emit('room-joined', { roomId: room.id, player: room.players[this.ownId] });
                this.emit('room-updated', room);
            }
            
            handleLeaveRoom(data) {
                if (!this.currentRoom) return;
                
                const room = this.currentRoom;
                delete room.players[this.ownId];
                room.currentPlayers = Object.keys(room.players).length;
                
                if (room.currentPlayers === 0) {
                    const index = this.rooms.findIndex(r => r.id === room.id);
                    if (index >= 0) this.rooms.splice(index, 1);
                }
                
                log(`离开房间: ${room.id}`);
                this.emit('room-left', { roomId: room.id, playerId: this.ownId });
                this.emit('room-updated', room);
                
                this.currentRoom = null;
                this.currentRoomId = null;
                this.isOwner = false;
            }
            
            handleReadyCheck(data) {
                if (!this.currentRoom) return;
                
                const room = this.currentRoom;
                if (room.players[this.ownId]) {
                    room.players[this.ownId].isReady = data.isReady;
                    
                    log(`准备状态更新: ${data.isReady ? '已准备' : '未准备'}`);
                    this.emit('room-updated', room);
                    
                    // 检查是否所有玩家都准备就绪
                    const allReady = Object.values(room.players).every(player => player.isReady);
                    if (allReady && room.status === 'waiting') {
                        room.status = 'ready';
                        log('所有玩家已准备就绪，10秒后自动开始游戏');
                        this.emit('all-players-ready', { roomId: room.id });
                        
                        setTimeout(() => {
                            this.handleStartRound({ roomId: room.id });
                        }, 10000);
                    }
                }
            }
            
            handleTeamManagement(data) {
                if (!this.currentRoom || this.currentRoom.ownerId !== this.ownId) {
                    log('队伍管理失败: 权限不足');
                    return;
                }
                
                const room = this.currentRoom;
                
                switch (data.action) {
                    case 'switch':
                        if (data.targetPlayerId && data.team) {
                            room.players[data.targetPlayerId].team = data.team;
                            log(`切换队伍: 玩家 ${data.targetPlayerId.slice(0, 8)} 切换到 ${data.team} 队`);
                        }
                        break;
                    case 'kick':
                        if (data.targetPlayerId && data.targetPlayerId !== this.ownId) {
                            delete room.players[data.targetPlayerId];
                            room.currentPlayers = Object.keys(room.players).length;
                            log(`踢出玩家: ${data.targetPlayerId.slice(0, 8)}`);
                            this.emit('player-kicked', { roomId: room.id, playerId: data.targetPlayerId });
                        }
                        break;
                    case 'promote':
                        if (data.targetPlayerId) {
                            room.ownerId = data.targetPlayerId;
                            log(`晋升房主: ${data.targetPlayerId.slice(0, 8)}`);
                        }
                        break;
                }
                
                this.emit('room-updated', room);
            }
            
            handleStartRound(data) {
                if (!this.currentRoom) return;
                
                const room = this.currentRoom;
                room.started = true;
                room.status = 'playing';
                
                log(`开始游戏: ${room.id}`);
                this.emit('start-round', { roundId: `round_${room.id}`, startPositions: [] });
                this.emit('room-updated', room);
            }
        }
        
        // 监听游戏开始事件
        networkClient.on('start-round', (data) => {
            log(`收到游戏开始事件: ${JSON.stringify(data)}`);
            log('游戏即将开始...');
        });
        
        // 监听房间更新事件
        networkClient.on('room-updated', (room) => {
            if (networkClient.currentRoom && room.id === networkClient.currentRoom.id) {
                networkClient.currentRoom = room;
                updateRoomInfo(room);
                updatePlayerList(room);
                
                // 检查游戏是否已开始
                if (room.started) {
                    log('游戏已开始！');
                }
            }
        });
        
        // 初始化网络客户端
        const networkClient = new MockNetworkClient();
        
        // 监听房间更新事件
        networkClient.on('room-updated', (room) => {
            updateRoomInfo(room);
            updatePlayerList(room);
        });
        
        networkClient.on('room-joined', (data) => {
            log(`加入房间: ${data.roomId}`);
            updateRoomInfo(networkClient.currentRoom);
            updatePlayerList(networkClient.currentRoom);
        });
        
        networkClient.on('room-left', (data) => {
            log(`离开房间: ${data.roomId}`);
            updateRoomInfo(null);
            updatePlayerList(null);
        });
        
        networkClient.on('all-players-ready', (data) => {
            log(`所有玩家准备就绪: ${data.roomId}`);
        });
        
        networkClient.on('start-round', (data) => {
            log(`游戏开始: ${data.roundId}`);
        });
        
        networkClient.on('player-kicked', (data) => {
            log(`玩家被踢出: ${data.playerId.slice(0, 8)}`);
        });
        
        // UI更新函数
        function updateRoomInfo(room) {
            if (room) {
                document.getElementById('roomId').textContent = room.id;
                document.getElementById('roomName').textContent = room.name;
                document.getElementById('playerCount').textContent = room.currentPlayers;
                document.getElementById('roomStatus').textContent = 
                    room.status === 'waiting' ? '等待中' :
                    room.status === 'ready' ? '已准备' :
                    room.status === 'playing' ? '游戏中' : '未知';
            } else {
                document.getElementById('roomId').textContent = '-';
                document.getElementById('roomName').textContent = '-';
                document.getElementById('playerCount').textContent = '0';
                document.getElementById('roomStatus').textContent = '未创建';
            }
        }
        
        function updatePlayerList(room) {
            if (!room) {
                document.getElementById('redTeam').innerHTML = '';
                document.getElementById('blueTeam').innerHTML = '';
                return;
            }
            
            const redTeam = Object.values(room.players).filter(p => p.team === 'red');
            const blueTeam = Object.values(room.players).filter(p => p.team === 'blue');
            
            document.getElementById('redTeam').innerHTML = redTeam.map(player => `
                <div class="player red ${player.isReady ? 'ready' : 'not-ready'}">
                    <span>${player.id === networkClient.ownId ? '我' : player.id.slice(0, 8)}</span>
                    <div class="player-actions">
                        ${networkClient.isOwner && player.id !== networkClient.ownId ? 
                            `<button class="button danger" onclick="kickPlayer('${player.id}')">踢出</button>` : ''}
                        <button class="button warning" onclick="switchPlayerTeam('${player.id}')">换队</button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('blueTeam').innerHTML = blueTeam.map(player => `
                <div class="player blue ${player.isReady ? 'ready' : 'not-ready'}">
                    <span>${player.id === networkClient.ownId ? '我' : player.id.slice(0, 8)}</span>
                    <div class="player-actions">
                        ${networkClient.isOwner && player.id !== networkClient.ownId ? 
                            `<button class="button danger" onclick="kickPlayer('${player.id}')">踢出</button>` : ''}
                        <button class="button warning" onclick="switchPlayerTeam('${player.id}')">换队</button>
                    </div>
                </div>
            `).join('');
        }
        
        // 日志函数
        function log(message) {
            const logElement = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${time}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // 房间操作函数
        function createRoom() {
            networkClient.send('create-room', {
                name: '测试房间',
                settings: {
                    gameMode: 'team-deathmatch',
                    maxPlayers: 10
                }
            });
        }
        
        function joinRoom() {
            if (networkClient.rooms.length === 0) {
                log('没有可加入的房间，请先创建房间');
                return;
            }
            
            const roomId = networkClient.rooms[0].id;
            networkClient.send('join-room', { roomId });
        }
        
        function leaveRoom() {
            if (!networkClient.currentRoom) {
                log('您当前不在任何房间中');
                return;
            }
            
            networkClient.send('leave-room', { roomId: networkClient.currentRoomId });
        }
        
        function toggleReady() {
            if (!networkClient.currentRoom) {
                log('您当前不在任何房间中');
                return;
            }
            
            const player = networkClient.currentRoom.players[networkClient.ownId];
            const isReady = !player.isReady;
            
            networkClient.send('ready-check', {
                roomId: networkClient.currentRoomId,
                isReady: isReady
            });
        }
        
        function startGame() {
            if (!networkClient.currentRoom) {
                log('您当前不在任何房间中');
                return;
            }
            
            if (!networkClient.isOwner) {
                log('只有房主才能开始游戏');
                return;
            }
            
            networkClient.send('start-round', {
                roomId: networkClient.currentRoomId
            });
        }
        
        function kickPlayer(playerId) {
            if (!networkClient.currentRoom) {
                log('您当前不在任何房间中');
                return;
            }
            
            if (!networkClient.isOwner) {
                log('只有房主才能踢出玩家');
                return;
            }
            
            networkClient.send('team-management', {
                roomId: networkClient.currentRoomId,
                action: 'kick',
                targetPlayerId: playerId
            });
        }
        
        function switchPlayerTeam(playerId) {
            if (!networkClient.currentRoom) {
                log('您当前不在任何房间中');
                return;
            }
            
            const player = networkClient.currentRoom.players[playerId];
            if (!player) {
                log('玩家不存在');
                return;
            }
            
            const targetTeam = player.team === 'red' ? 'blue' : 'red';
            
            networkClient.send('team-management', {
                roomId: networkClient.currentRoomId,
                action: 'switch',
                targetPlayerId: playerId,
                team: targetTeam
            });
        }
        
        // 测试函数
        function testKickPlayer() {
            if (!networkClient.currentRoom || !networkClient.isOwner) {
                log('请先创建房间并加入');
                return;
            }
            
            // 添加一个模拟玩家
            const mockPlayerId = `mock_${Math.random().toString(36).slice(2,9)}`;
            networkClient.currentRoom.players[mockPlayerId] = {
                id: mockPlayerId,
                team: 'blue',
                isReady: true,
                role: 'support'
            };
            networkClient.currentRoom.currentPlayers = Object.keys(networkClient.currentRoom.players).length;
            
            updateRoomInfo(networkClient.currentRoom);
            updatePlayerList(networkClient.currentRoom);
            
            log(`添加模拟玩家: ${mockPlayerId.slice(0, 8)}`);
            
            // 延迟踢出
            setTimeout(() => {
                kickPlayer(mockPlayerId);
            }, 1000);
        }
        
        function testSwitchTeam() {
            if (!networkClient.currentRoom) {
                log('请先创建房间并加入');
                return;
            }
            
            // 添加一个模拟玩家
            const mockPlayerId = `mock_${Math.random().toString(36).slice(2,9)}`;
            networkClient.currentRoom.players[mockPlayerId] = {
                id: mockPlayerId,
                team: 'red',
                isReady: true,
                role: 'support'
            };
            networkClient.currentRoom.currentPlayers = Object.keys(networkClient.currentRoom.players).length;
            
            updateRoomInfo(networkClient.currentRoom);
            updatePlayerList(networkClient.currentRoom);
            
            log(`添加模拟玩家: ${mockPlayerId.slice(0, 8)}`);
            
            // 延迟切换队伍
            setTimeout(() => {
                switchPlayerTeam(mockPlayerId);
            }, 1000);
        }
        
        function testReadyCheck() {
            if (!networkClient.currentRoom) {
                log('请先创建房间并加入');
                return;
            }
            
            // 添加模拟玩家并设置为准备状态
            for (let i = 0; i < 2; i++) {
                const mockPlayerId = `mock_${Math.random().toString(36).slice(2,9)}`;
                networkClient.currentRoom.players[mockPlayerId] = {
                    id: mockPlayerId,
                    team: i % 2 === 0 ? 'red' : 'blue',
                    isReady: true,
                    role: 'support'
                };
            }
            networkClient.currentRoom.currentPlayers = Object.keys(networkClient.currentRoom.players).length;
            
            updateRoomInfo(networkClient.currentRoom);
            updatePlayerList(networkClient.currentRoom);
            
            log('添加模拟玩家并设置为准备状态');
            
            // 延迟准备
            setTimeout(() => {
                toggleReady();
            }, 1000);
        }
        
        function testStartRound() {
    if (!networkClient.currentRoom || !networkClient.isOwner) {
        log('请先创建房间并加入');
        return;
    }
    
    // 添加模拟玩家并设置为准备状态
    for (let i = 0; i < 2; i++) {
        const mockPlayerId = `mock_${Math.random().toString(36).slice(2,9)}`;
        networkClient.currentRoom.players[mockPlayerId] = {
            id: mockPlayerId,
            team: i % 2 === 0 ? 'red' : 'blue',
            isReady: true,
            role: 'support'
        };
    }
    networkClient.currentRoom.currentPlayers = Object.keys(networkClient.currentRoom.players).length;
    
    // 设置自己为准备状态
    networkClient.currentRoom.players[networkClient.ownId].isReady = true;
    
    updateRoomInfo(networkClient.currentRoom);
    updatePlayerList(networkClient.currentRoom);
    
    log('添加模拟玩家并设置为准备状态');
    
    // 检查所有玩家是否准备就绪
    const allReady = Object.values(networkClient.currentRoom.players).every(player => player && player.isReady === true);
    log(`所有玩家准备状态: ${allReady}`);
    
    if (allReady) {
        log('所有玩家已准备就绪，10秒后自动开始游戏');
        setTimeout(() => {
            log('尝试开始游戏...');
            startGame();
        }, 1000);
    } else {
        log('有玩家未准备就绪，无法开始游戏');
    }
}
        
        // 初始化
        log('房间管理功能测试页面已加载');
    </script>
</body>
</html>