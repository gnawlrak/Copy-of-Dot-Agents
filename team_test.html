<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>队伍分配测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .player {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .red-team {
            background-color: rgba(255, 0, 0, 0.3);
            border-left: 5px solid #ff0000;
        }
        .blue-team {
            background-color: rgba(0, 0, 255, 0.3);
            border-left: 5px solid #0000ff;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        .room-info {
            background-color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .team-container {
            display: flex;
            gap: 20px;
        }
        .team-column {
            flex: 1;
            background-color: #222;
            padding: 15px;
            border-radius: 5px;
        }
        .team-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        .red-title {
            color: #ff6b6b;
        }
        .blue-title {
            color: #6b9fff;
        }
        .log {
            background-color: #111;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>队伍分配测试</h1>
        
        <div class="room-info">
            <h3>房间信息</h3>
            <p>房间ID: <span id="roomId">test-room</span></p>
            <p>玩家总数: <span id="playerCount">0</span></p>
            <p>红队人数: <span id="redCount">0</span></p>
            <p>蓝队人数: <span id="blueCount">0</span></p>
        </div>
        
        <div>
            <button id="addPlayer">添加玩家</button>
            <button id="clearPlayers">清空玩家</button>
            <button id="testBalance">测试平衡性</button>
        </div>
        
        <div class="team-container">
            <div class="team-column">
                <div class="team-title red-title">红队</div>
                <div id="redTeam"></div>
            </div>
            <div class="team-column">
                <div class="team-title blue-title">蓝队</div>
                <div id="blueTeam"></div>
            </div>
        </div>
        
        <div>
            <h3>日志</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        // 模拟房间数据
        let room = {
            id: 'test-room',
            players: {}
        };
        
        // 日志函数
        function log(message) {
            const logElement = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${time}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // 分配队伍的函数（与修复后的逻辑相同）
        function assignTeam(room) {
            // 获取当前房间中红队和蓝队的玩家数量
            const redTeamCount = Object.values(room.players).filter(player => player.team === 'red').length;
            const blueTeamCount = Object.values(room.players).filter(player => player.team === 'blue').length;
            
            // 随机分配队伍，尽量保持两队人数平衡
            let assignedTeam;
            if (redTeamCount === blueTeamCount) {
                // 如果两队人数相等，随机分配
                assignedTeam = Math.random() < 0.5 ? 'red' : 'blue';
            } else {
                // 如果人数不等，分配到人数较少的队伍
                assignedTeam = redTeamCount < blueTeamCount ? 'red' : 'blue';
            }
            
            return assignedTeam;
        }
        
        // 添加玩家
        function addPlayer() {
            const playerId = `player_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
            const team = assignTeam(room);
            
            room.players[playerId] = {
                id: playerId,
                team: team,
                name: `玩家${Object.keys(room.players).length + 1}`
            };
            
            log(`添加玩家 ${playerId.slice(0, 20)} 到 ${team === 'red' ? '红队' : '蓝队'}`);
            updateUI();
        }
        
        // 清空玩家
        function clearPlayers() {
            room.players = {};
            log('清空所有玩家');
            updateUI();
        }
        
        // 测试平衡性
        function testBalance() {
            clearPlayers();
            log('开始测试队伍平衡性...');
            
            // 添加20个玩家
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    addPlayer();
                    
                    // 如果是最后一个玩家，计算平衡性
                    if (i === 19) {
                        setTimeout(() => {
                            const redCount = Object.values(room.players).filter(p => p.team === 'red').length;
                            const blueCount = Object.values(room.players).filter(p => p.team === 'blue').length;
                            const difference = Math.abs(redCount - blueCount);
                            
                            log(`测试完成: 红队 ${redCount} 人, 蓝队 ${blueCount} 人, 差异 ${difference} 人`);
                            
                            if (difference <= 1) {
                                log('✅ 队伍分配平衡性测试通过！');
                            } else {
                                log('❌ 队伍分配平衡性测试失败！');
                            }
                        }, 100);
                    }
                }, i * 100);
            }
        }
        
        // 更新UI
        function updateUI() {
            const redTeam = Object.values(room.players).filter(player => player.team === 'red');
            const blueTeam = Object.values(room.players).filter(player => player.team === 'blue');
            
            // 更新房间信息
            document.getElementById('playerCount').textContent = Object.keys(room.players).length;
            document.getElementById('redCount').textContent = redTeam.length;
            document.getElementById('blueCount').textContent = blueTeam.length;
            
            // 更新红队列表
            const redTeamElement = document.getElementById('redTeam');
            redTeamElement.innerHTML = redTeam.map(player => 
                `<div class="player red-team">
                    <span>${player.name}</span>
                    <span>${player.id.slice(0, 15)}</span>
                </div>`
            ).join('');
            
            // 更新蓝队列表
            const blueTeamElement = document.getElementById('blueTeam');
            blueTeamElement.innerHTML = blueTeam.map(player => 
                `<div class="player blue-team">
                    <span>${player.name}</span>
                    <span>${player.id.slice(0, 15)}</span>
                </div>`
            ).join('');
        }
        
        // 绑定事件
        document.getElementById('addPlayer').addEventListener('click', addPlayer);
        document.getElementById('clearPlayers').addEventListener('click', clearPlayers);
        document.getElementById('testBalance').addEventListener('click', testBalance);
        
        // 初始化UI
        updateUI();
        log('队伍分配测试页面已加载');
    </script>
</body>
</html>