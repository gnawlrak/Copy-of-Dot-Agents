<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BroadcastChannel 跨标签页通信测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { margin: 5px; padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 3px; margin-top: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .status { padding: 10px; border-radius: 3px; margin: 10px 0; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>BroadcastChannel 跨标签页通信测试</h1>
        
        <div class="test-section">
            <h3>测试说明</h3>
            <p>打开多个此页面的标签页，测试BroadcastChannel是否能实现跨标签页的房间数据同步。</p>
            <button onclick="openNewTab()">打开新标签页</button>
            <button onclick="clearLogs()">清空日志</button>
        </div>

        <div class="test-section">
            <h3>连接状态</h3>
            <div id="status" class="status">等待连接...</div>
        </div>

        <div class="test-section">
            <h3>房间操作</h3>
            <button onclick="createRoom()">创建测试房间</button>
            <button onclick="listRooms()">列出所有房间</button>
            <button onclick="clearRooms()">清空所有房间</button>
        </div>

        <div class="test-section">
            <h3>实时日志</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        // 创建BroadcastChannel
        const channel = new BroadcastChannel('dot_agents_rooms');
        let rooms = [];
        let isConnected = false;

        // 更新状态显示
        function updateStatus() {
            const statusEl = document.getElementById('status');
            statusEl.textContent = isConnected ? 'BroadcastChannel 已连接' : 'BroadcastChannel 未连接';
            statusEl.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
        }

        // 添加日志
        function addLog(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // 监听消息
        channel.addEventListener('message', (event) => {
            const message = event.data;
            addLog(`收到消息: ${JSON.stringify(message)}`);
            
            if (message.type === 'rooms_updated') {
                rooms = message.rooms;
                addLog(`房间列表已更新: ${rooms.length} 个房间`);
                updateRoomDisplay();
            }
        });

        // 更新房间显示
        function updateRoomDisplay() {
            addLog(`当前房间数量: ${rooms.length}`);
            rooms.forEach(room => {
                addLog(`房间: ${room.name} (ID: ${room.id}), 玩家: ${Object.keys(room.players || {}).length}`);
            });
        }

        // 发送房间更新
        function sendRoomsUpdate() {
            const message = {
                type: 'rooms_updated',
                rooms: rooms,
                timestamp: Date.now(),
                source: 'test_page'
            };
            
            channel.postMessage(message);
            addLog(`发送房间更新: ${rooms.length} 个房间`);
        }

        // 创建测试房间
        function createRoom() {
            const roomId = 'test_room_' + Math.random().toString(36).slice(2, 9);
            const room = {
                id: roomId,
                name: '测试房间 ' + roomId.slice(-4),
                ownerId: 'test_player',
                players: {},
                createdAt: Date.now(),
                status: 'waiting',
                type: 'public',
                settings: { gameMode: 'team_deathmatch' },
                currentPlayers: 0,
                region: 'asia',
                ping: 50,
                tags: ['test'],
                statistics: { gamesPlayed: 0, averageDuration: 0, playerSatisfaction: 0, successRate: 0 }
            };
            
            rooms.push(room);
            addLog(`创建房间: ${room.name}`);
            sendRoomsUpdate();
        }

        // 列出所有房间
        function listRooms() {
            addLog('=== 当前房间列表 ===');
            updateRoomDisplay();
            addLog('===================');
        }

        // 清空所有房间
        function clearRooms() {
            rooms = [];
            addLog('已清空所有房间');
            sendRoomsUpdate();
        }

        // 打开新标签页
        function openNewTab() {
            window.open(window.location.href, '_blank');
        }

        // 清空日志
        function clearLogs() {
            document.getElementById('log').innerHTML = '';
        }

        // 初始化
        window.addEventListener('load', () => {
            isConnected = true;
            updateStatus();
            addLog('BroadcastChannel 测试页面已加载');
            addLog('请打开多个标签页测试跨标签页通信');
        });

        // 页面卸载时关闭连接
        window.addEventListener('beforeunload', () => {
            channel.close();
        });
    </script>
</body>
</html>